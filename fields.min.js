(function(){var Evaluation,EvaluationCollection,Field,FieldCollection;Field=function(){function Field(element){this.el=$(element);this.attributes={};this.setupBindings();this.setAttributes();this}Field.prototype.get=function(attr){return this.attributes[attr]};Field.prototype.set=function(attr,value){this.attributes[attr]=value;if(this.oldAttributes[attr]===void 0||value!==this.oldAttributes[attr]){return this.el.triggerHandler("change:"+attr,[this,value])}};Field.prototype.refresh=function(){return this.setAttributes()};Field.prototype.name=function(){return this.el.attr("name")};Field.prototype.required=function(){return this.el.hasClass("required"||this.el.is("[required]"))};Field.prototype.hidden=function(){return this.el.attr("type")==="hidden"};Field.prototype.value=function(){return this.el.val()};Field.prototype.empty=function(){return this.el.val().length===0};Field.prototype.evaluate=function(){return $.extend(this.attributes,EvaluationRegistry.evaluate(this.el))};Field.prototype.valid=function(){return!(this.get("errors")!=null)};Field.prototype.setupBindings=function(){var _this=this;$(window).on("evaluation:add",function(){return _this.evaluate()});return this.el.on("keyup blur focus change",function(){return _this.setAttributes()})};Field.prototype.saveAttributes=function(attrs){this.oldAttributes=attrs;return this.attributes={}};Field.prototype.setAttributes=function(){this.saveAttributes(this.attributes);this.set("required",this.required());this.set("empty",this.empty());if(this.get("required")&&this.get("empty")){this.set("errors",["Field required"])}else{this.evaluate()}this.set("name",this.name());this.set("hidden",this.hidden());this.set("valid",this.valid());return this.set("value",this.value())};return Field}();FieldCollection=function(){function FieldCollection(element){this.el=$(element);this.fields=this.el.find('input:not([type="submit"]), select, textarea');this.models=[];this.attributes={valid:false};this.createFieldModels();this.trackFocus();this.trackValidity();this.getValidity();this}FieldCollection.prototype.get=function(attr){return this.attributes[attr]};FieldCollection.prototype.set=function(attr,value){var old_attribute;old_attribute=this.attributes[attr];this.attributes[attr]=value;if(value!==this.old_attribute){return this.el.triggerHandler("change:"+attr,[this,value])}};FieldCollection.prototype.at=function(name){var model,_i,_len,_ref;_ref=this.models;for(_i=0,_len=_ref.length;_i<_len;_i++){model=_ref[_i];if(model.get("name")===name){return model}}};FieldCollection.prototype.collect=function(value){var dict,model,_i,_len,_ref;dict={};_ref=this.models;for(_i=0,_len=_ref.length;_i<_len;_i++){model=_ref[_i];dict[model.get("name")]=model.get(value)}return dict};FieldCollection.prototype.refresh=function(){var model,_i,_len,_ref,_results;_ref=this.models;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){model=_ref[_i];_results.push(model.refresh())}return _results};FieldCollection.prototype.createFieldModels=function(){var field,model,_i,_len,_ref,_results;_ref=this.fields;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){field=_ref[_i];model=$(field).data("Field");if(model==null){model=new Field(field);$(field).data("Field",model)}_results.push(this.models.push(model))}return _results};FieldCollection.prototype.getValidity=function(){var model,valid,_i,_len,_ref;valid=true;_ref=this.models;for(_i=0,_len=_ref.length;_i<_len;_i++){model=_ref[_i];if(model.get("valid")===false){valid=false}}return this.set("valid",valid)};FieldCollection.prototype.trackValidity=function(){var _this=this;return $(this.fields).on("change:valid",function(e){return _this.getValidity()})};FieldCollection.prototype.trackFocus=function(){var _this=this;return $(this.fields).on("focus",function(e){return _this.set("last_focused",$(e.target))})};return FieldCollection}();Evaluation=function(){function Evaluation(selector,context,statement){this.selector=selector;this.context=context;this.statement=statement;$(window).trigger("evaluation:create",this)}Evaluation.prototype.evaluate=function(field){return this.statement(field)};return Evaluation}();EvaluationCollection=function(){function EvaluationCollection(){var _this=this;this.evaluations=[];$(window).on("evaluation:create",function(e,evaluation){return _this.add(evaluation)})}EvaluationCollection.prototype.evaluate=function(field){var evaluation,result,results,_i,_len,_ref;results={};_ref=this.evaluations;for(_i=0,_len=_ref.length;_i<_len;_i++){evaluation=_ref[_i];if(!field.is(evaluation.selector)){continue}result=evaluation.evaluate(field);if(result!==void 0){if(results[evaluation.context]==null){results[evaluation.context]=[]}results[evaluation.context].push(result)}}return results};EvaluationCollection.prototype.add=function(evaluation){this.evaluations.push(evaluation);return $(window).trigger("evaluation:add")};return EvaluationCollection}();window.FieldEvaluation=Evaluation;window.EvaluationRegistry||(window.EvaluationRegistry=new EvaluationCollection);$.fn.collectFieldData=function(option){var $el,data,field;$el=$(this);field='input:not([type="submit"]), select, textarea';if($el.is(field)){data=$el.data("Field");if(data==null){data=new Field($el);$el.data("Field",data)}}else{data=$el.data("FieldCollection");if(data==null){data=new FieldCollection($el);$el.data("FieldCollection",data)}}return data}}).call(this);